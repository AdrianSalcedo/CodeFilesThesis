---
title: "Tomato Model"
author: "Gabriel A. Salcedo-Varela"
date: "`r Sys.Date()`"
output:
    #html_document:
    rmdformats::readthedown:
    # df_print: paged
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    # highlight: tango
    # html_document:
    # gallery: false
    # # df_print: paged
    # self_contained: true
    bibliography: biblio.bib
    # lightbox: true
    # rmdformats::readthedown:
    # highlight: tango
    # thumbnails: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
We describe a model for tomato yellow curl leaf virus disease and using @Holt1999 data 
we implement the model in Stan. The model used is bases on a SLI-SI model and it is fitted
to each tomato specie data.

Thus, the model is described by the following formulation: 

\begin{align}
    S_p'& =
        -\beta_p S_p I_v + r_1 L_p + r_2 I_p
        \\
    L_p'& =
        \beta_p S_p I_v -(b + r_1) L_p
        \\
    I_p'& = 
        b L_p - r_2 I_p
        \\
    S_v'&= 
        -\beta_v S_v I_p - (\gamma + \gamma_f) S_v + (1 - \theta) \mu
        \\
    I_v'&= 
        \beta_v S_v I_p - (\gamma + \gamma_f) I_v +\theta \mu
        \\
    N_p(t)&= 
        S_p + L_p + I_p
        \\
    N_v(t)&= 
        S_v + I_v
\end{align}

with $S_p(t)$, $L_p(t)$ and $I_p(t)$ represents the number of susceptibles, latented
and infected plants at time t (in days) in the crop. $N_p(t)$ is the total population
size $(N_p=S_p + L_p + I_p)$. $\beta_p$ is the rate of transmission of susceptible
plants by infected vectors, $r_1$, $r_2$ are replanting rates of latent and infected
plants, respectively, $b$ latency rate, plant latent becomes infectious. 
$\beta_v$ is the infection rate of susceptible vectors by an infected plant.
$\gamma$, $\gamma_f$ are vector death and fumigation rate. $\mu$ is the vector
migration rates from alternative plants to crop and $\theta$ is the proportion vector
migration rate. 

Observation Model
=================
The unique solution of ODE model is defined when we give the parameters and
initial conditions, this solution include the number of new infected plants,
$\lambda_t$. We want to link the solution of ODE model with the observed data,
the number of infected cases, $I_{obs}(t)$, at each time point. 
We decide to model the number of infected plants with a count distribution â€“ the
Negative Binomial. This distribution admits us to use the incidence $\lambda_t$
as the expected value and account for over-dispersion, through the parameter $\phi$:
\begin{align}
    Y_t &
        \sim \text{Negative Binomial}(\lambda_t, \phi), \qquad
    \\
    \lambda_t &
        =  \int_0^t b L_p(s)ds
    \\
        &   \beta_p \sim \text{Normal(0.01,0.001)}
    \\
        &   r_1 \sim \text{Inv-Gamma(2.005,0.01005)}
    \\    
        &   r_2 \sim \text{Inv-Gamma(2.005,0.01005)}
    \\
        &   b \sim \text{Inv-Gamma(70.625,0.496875)}
    \\
        &  \beta_v \sim \text{Normal(0.001,0.001)}
    \\  
        &  \theta \sim \text{Normal(0.4, 0.1)}
    \\
        &   \phi \sim \text{Exponential(1.9)}
\end{align}

Stan ODE notation beginning model
=================================

|state                  |Stan| Initial Condition       |Stan     |Postulated |
|-----------------------|----|-------------------------|---------|-----------|
|$S_p$                  |y[1]| $S_{p_0}$               |y_init[1]|$N_p -
                                                                  (L_{p_0} + 
                                                                  I_{p_0})$     |
|$L_p$                  |y[2]| $L_{p_0}$               |y_init[2]|L_{p_0}       |
|$I_p$                  |y[3]| $I_{p_0}$               |y_init[3]|I_{p_0}       |
|$S_v$                  |y[4]| $S_{v_0}$               |y_init[4]|S_{v_0}       |
|$I_v$                  |y[5]| $I_{v_0}$               |y_init[5]|I_{v_0}       |
|$I_p^{[cumulative]}$   |y[6]| $I_{p_0}^{[cumulative]}$|y_init[6]|Y_{p_0}       |

Parameters estimation
==========================================

|stan notation| symbol     |Prior          | Fixed      | Range |
|-------------|---------   |---------------|------------|------------|
|theta[1]     |$\beta_p$   | normal(0.01,0.001)|            |(0,0.1)|
|theta[2]     |$r_1$       | inv_gamma(2.005,0.01005)   |    0.01    |(0.0083,0.013)|
|theta[3]     |$r_2$       | inv_gamma(2.005,0.01005)   |    0.01    |(0.0083,0.013)|
|theta[4]     |$b$         | inv_gamma(70.625,0.496875)|            |(0.05,0.1) |
|theta[5]     |$\beta_v$   | normal(0.001,0.001) |            | (0,0.2)|
|theta[6]     |$\gamma$    | -----------   |    0.15    | (0.03,1)|
|theta[7]     |$\gamma_f$  | -----------   |    0.15    |(0.03,1)|
|theta[8]     |$\theta$    | normal(0.4, 0.1)|          |(0, 1)|
|theta[9]     |$\mu$       |  -----------  |   1.0      |(0, 1)|
|y_init[1]    |$S_{p_{0}}$ |  -----------  | $1000 - L_{p_0} + I_{p_0}$   ||
|y_init[2]    |$L_{p_{0}}$ |  -----------  |   95        | |
|y_init[3]    |$I_{p_{0}}$ |  -----------  |    150      | |
|y_init[4]    |$S_{v_{0}}$ |  -----------  |    2.0e+04  | | 
|y_init[5]    |$I_{v_{0}}$ |  -----------  |    4.50e+01 | |

Stan estimation LA 1582 specie data
===============================
```{r}
library(knitr)
library(kableExtra)
#
sub_path_1 <- "/home/gabrielsalcedo"
sub_path_2 <- "Documentos/TYLCVD-fit"
sub_path_3 <- "Model5/estimation/LA_data"
file_name <- "last_est.csv"
path <- paste(sub_path_1, sub_path_2, sub_path_3, file_name, sep = "/")
parameters_df <- read.csv(path, header=FALSE,skip = 1)
parameters_df <- data.frame(parameters_df)
#
colnames(parameters_df) <- c("theta",
                        "mean", 
                        'se_mean',
                        'sd',
                        '2.5%', '25%','50%', '75%' ,'97.5%',
                        'n_eff',
                        'Rhat')
kable(parameters_df)  %>%
  kable_styling(bootstrap_options = "striped", full_width = T)

```
Stan estimation tyking specie data
===============================
```{r}
library(knitr)
library(kableExtra)
#
sub_path_1 <- "/home/gabrielsalcedo"
sub_path_2 <- "Documentos/TYLCVD-fit"
sub_path_3 <- "Model5/estimation/tyking_data"
file_name <- "last_est.csv"
path <- paste(sub_path_1, sub_path_2, sub_path_3, file_name, sep = "/")
parameters_df <- read.csv(path, header=FALSE,skip = 1)
parameters_df <- data.frame(parameters_df)
#
colnames(parameters_df) <- c("theta",
                        "mean", 
                        'se_mean',
                        'sd',
                        '2.5%', '25%','50%', '75%' ,'97.5%',
                        'n_eff',
                        'Rhat')
kable(parameters_df)  %>%
  kable_styling(bootstrap_options = "striped", full_width = T)

```
Results
===========================================
```{r, echo=FALSE, fig.cap="Inference results using NUTs for TLCVD no resisitence tomato specie data. Fit the deterministic model to the data.", out.width = '100%'}
knitr::include_graphics("/home/gabrielsalcedo/Documentos/TYLCVD-fit/no_resistance_fit_data.png")
```
```{r image, echo=FALSE, fig.cap="Inference results using NUTs for TLCVD resisitence tomato specie data. Fit the deterministic model to the data.", out.width = '100%'}
knitr::include_graphics("/home/gabrielsalcedo/Documentos/TYLCVD-fit/resistance_fit_data.png")
```
For this adjustments we use all data bases of Holt et al. [@Holt1999]. We observe that almost all no 
resistance specie data are outside the confidence band, but the fitted curve is closer to the
first data than to the last data, due to the abrupt growth in the number of infected cases
that occur. 
On the other hand, the adjustment made with the data of resistant species can be observed that
after $40$ days, the confidentiality band conforms to most of the data, unlike the
confidentiality bands of the data of nonresistant species.
The results showed that the curves adjusted with the SLI-SI model for each of the tomato
species behaves similarly to the data.


Stan model for tomato LA 1582 specie data
===============================
```{r}
library(rstan)
writeLines(readLines("sirTomato2.stan"))
```
Stan model for tomato tyking specie data
===============================
```{r}
library(rstan)
writeLines(readLines("sirTomato3.stan"))
```

##References






